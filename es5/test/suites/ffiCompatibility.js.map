{"version":3,"sources":["../../../test/suites/ffiCompatibility.js"],"names":["ffi","require","ref","ArrayType","UnionType","StructType","Library","Callback","FfiFunction","Function","helpers","assert","_","Promise","async","coroutine","describe","libPath","before","findTestlib","it","isObject","isFunction","lib","mul","getString","equal","readCString","release","done","asyncPromise","err","res","setImmediate","isUndefined","cbFunc","types","float","makeInt","v","cb","double","cb2","toPointer","deepEqual","keys","_library","callbacks","IntArray","isArrayNull","TRecWithArray","values","long","index","TRecWithArrays","incRecWithArrays","structs","arrays","records","get","i","TUnion","a","b","c","TTaggedUnion","tag","data","getValueFromTaggedUnion","refType","unions","struct","charCodeAt","result","ImageFormat","imageChannelOrder","imageChannelDataType","Context","MemFlags","uint64","MemObjectType","uint","ImageFormatArray","clGetSupportedImageFormats","numFormats","alloc","handle","deref","appendChar","CString","readChar","str","allocCString","newStr","StringArray","concatStrings","arr","set","out","Buffer","fill","length"],"mappings":"AAAA;;;;;;;;;;;;;;;;AAgBA;;AACA,IAAMA,MAAMC,QAAQ,WAAR,EAAqBD,GAAjC;AACA,IAAME,MAAMF,IAAIE,GAAhB;AACA,IAAMC,YAAYH,IAAIG,SAAtB;AACA,IAAMC,YAAYJ,IAAII,SAAtB;AACA,IAAMC,aAAaL,IAAIK,UAAvB;AACA,IAAMC,UAAUN,IAAIM,OAApB;AACA,IAAMC,WAAWP,IAAIO,QAArB;AACA,IAAMC,cAAcR,IAAIS,QAAxB;AACA,IAAMC,UAAUT,QAAQ,WAAR,CAAhB;AACA,IAAMU,SAASV,QAAQ,QAAR,CAAf;AACA,IAAMW,IAAIX,QAAQ,QAAR,CAAV;AACA,IAAMY,UAAUZ,QAAQ,UAAR,CAAhB;AACA,IAAMa,QAAQD,QAAQE,SAAtB;;AAEAC,SAAS,mBAAT,EAA8B,YAAY;AACtC,QAAIC,UAAU,IAAd;AACAC,WAAOJ,8BAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BACOJ,QAAQS,WAAR,EADP;;AAAA;AACTF,+BADS;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAN,EAAP;;AAIAG,OAAG,6BAAH,EAAkC,YAAY;AAC1CT,eAAOC,EAAES,QAAF,CAAWrB,GAAX,CAAP;AACAW,eAAOC,EAAES,QAAF,CAAWnB,GAAX,CAAP;AACAS,eAAOC,EAAEU,UAAF,CAAanB,SAAb,CAAP;AACAQ,eAAOC,EAAEU,UAAF,CAAalB,SAAb,CAAP;AACAO,eAAOC,EAAEU,UAAF,CAAajB,UAAb,CAAP;AACAM,eAAOC,EAAEU,UAAF,CAAahB,OAAb,CAAP;AACAK,eAAOC,EAAEU,UAAF,CAAaf,QAAb,CAAP;AACH,KARD;;AAUAS,aAAS,WAAT,EAAsB,YAAY;AAC9BI,WAAG,uCAAH,EAA4C,YAAY;AACpD,gBAAMG,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BO,qBAAK,CAAE,KAAF,EAAS,CAAE,KAAF,EAAS,KAAT,CAAT,CADwB;AAE7BC,2BAAW,CAAE,OAAF,EAAW,EAAX;AAFkB,aAArB,CAAZ;;AAKA,gBAAI;AACAd,uBAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAjB,CAAP;AACAb,uBAAOe,KAAP,CAAaH,IAAIC,GAAJ,CAAQ,EAAR,EAAY,CAAZ,CAAb,EAA6B,EAA7B;AACAb,uBAAOe,KAAP,CAAaxB,IAAIyB,WAAJ,CAAgBJ,IAAIE,SAAJ,EAAhB,CAAb,EAA+C,OAA/C;AACH,aAJD,SAKQ;AACJF,oBAAIK,OAAJ;AACH;AACJ,SAdD;;AAgBAZ,iBAAS,OAAT,EAAkB,YAAY;AAC1BI,eAAG,sBAAH,EAA2B,UAAUS,IAAV,EAAgB;AACvC,oBAAMN,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BO,yBAAK,CAAE,KAAF,EAAS,CAAE,KAAF,EAAS,KAAT,CAAT;AADwB,iBAArB,CAAZ;;AAIA,oBAAI;AACAb,2BAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAjB,CAAP;AACAb,2BAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAJ,CAAQV,KAArB,CAAP;AACAH,2BAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAJ,CAAQM,YAArB,CAAP;AACAP,wBAAIC,GAAJ,CAAQV,KAAR,CAAc,EAAd,EAAkB,CAAlB,EAAqB,UAACiB,GAAD,EAAMC,GAAN,EAAc;AAC/BC,qCAAa;AAAA,mCAAMV,IAAIK,OAAJ,EAAN;AAAA,yBAAb;AACA,4BAAIG,GAAJ,EAAS;AACLF,iCAAKE,GAAL;AACH;AACD,4BAAI;AACApB,mCAAOe,KAAP,CAAaM,GAAb,EAAkB,EAAlB;AACAH;AACH,yBAHD,CAIA,OAAOE,GAAP,EAAY;AACRF,iCAAKE,GAAL;AACH;AACJ,qBAZD;AAaH,iBAjBD,CAkBA,OAAOA,GAAP,EAAY;AACRR,wBAAIK,OAAJ;AACAC,yBAAKE,GAAL;AACH;AACJ,aA3BD;;AA6BAX,eAAG,sBAAH,EAA2B,UAAUS,IAAV,EAAgB;AACvC,oBAAMN,MAAMvB,IAAIM,OAAJ,CACRW,OADQ,EAER;AACIO,yBAAK,CAAE,KAAF,EAAS,CAAE,KAAF,EAAS,KAAT,CAAT;AADT,iBAFQ,EAKR;AACIV,2BAAO;AADX,iBALQ,CAAZ;;AASA,oBAAI;AACAH,2BAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAjB,CAAP;AACAb,2BAAOC,EAAEsB,WAAF,CAAcX,IAAIC,GAAJ,CAAQV,KAAtB,CAAP;AACAH,2BAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAJ,CAAQM,YAArB,CAAP;AACAP,wBAAIC,GAAJ,CAAQ,EAAR,EAAY,CAAZ,EAAe,UAACO,GAAD,EAAMC,GAAN,EAAc;AACzBC,qCAAa;AAAA,mCAAMV,IAAIK,OAAJ,EAAN;AAAA,yBAAb;AACA,4BAAIG,GAAJ,EAAS;AACLF,iCAAKE,GAAL;AACH;AACD,4BAAI;AACApB,mCAAOe,KAAP,CAAaM,GAAb,EAAkB,EAAlB;AACAH;AACH,yBAHD,CAIA,OAAOE,GAAP,EAAY;AACRF,iCAAKE,GAAL;AACH;AACJ,qBAZD;AAaH,iBAjBD,CAkBA,OAAOA,GAAP,EAAY;AACRR,wBAAIK,OAAJ;AACAC,yBAAKE,GAAL;AACH;AACJ,aAhCD;AAiCH,SA/DD;;AAiEAX,WAAG,mBAAH,EAAwBN,8BAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AACpBS,+BADoB,GACdvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BO,qCAAK,CAAE,KAAF,EAAS,CAAE,KAAF,EAAS,KAAT,CAAT;AADwB,6BAArB,CADc;AAAA;;AAMtBb,mCAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAjB,CAAP;AACAb,mCAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAJ,CAAQV,KAArB,CAAP;AACAH,mCAAOC,EAAEU,UAAF,CAAaC,IAAIC,GAAJ,CAAQM,YAArB,CAAP;AARsB,2CAStBnB,MATsB;AAAA;AAAA,mCASHY,IAAIC,GAAJ,CAAQM,YAAR,CAAqB,EAArB,EAAyB,CAAzB,CATG;;AAAA;AAAA;;AAAA,yCASfJ,KATe,kCAS0B,EAT1B;;AAAA;AAAA;;AAYtBH,gCAAIK,OAAJ;AAZsB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAN,EAAxB;AAeH,KAjGD;;AAmGAZ,aAAS,UAAT,EAAqB,YAAY;AAC7BA,iBAAS,MAAT,EAAiB,YAAY;AACzBI,eAAG,8BAAH,EAAmC,YAAY;AAC3C,oBAAMe,SAAS,IAAI3B,WAAJ,CAAgB,KAAhB,EAAuB,CAACN,IAAIkC,KAAJ,CAAUC,KAAX,EAAkB,QAAlB,CAAvB,CAAf;AACA,oBAAMd,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BqB,6BAAS,CAAC,KAAD,EAAQ,CAAC,OAAD,EAAU,QAAV,EAAoBH,MAApB,CAAR;AADoB,iBAArB,CAAZ;;AAIA,oBAAI;AAAA;AACA,4BAAII,IAAI,GAAR;AACA,4BAAMC,KAAK,IAAIjC,QAAJ,CACP,KADO,EACA,CAACL,IAAIkC,KAAJ,CAAUC,KAAX,EAAkB,QAAlB,CADA,EAEP,UAAUA,KAAV,EAAiBI,MAAjB,EAAyB;AACrB,mCAAOJ,QAAQI,MAAR,GAAiBF,CAAxB;AACH,yBAJM,CAAX;;AAMA,4BAAMG,MAAMP,OAAOQ,SAAP,CAAiB,UAAUN,KAAV,EAAiBI,MAAjB,EAAyB;AAClD,mCAAOJ,QAAQI,MAAR,GAAiBF,CAAxB;AACH,yBAFW,CAAZ;;AAIA5B,+BAAOC,EAAEU,UAAF,CAAaC,IAAIe,OAAjB,CAAP;AACA3B,+BAAOC,EAAEU,UAAF,CAAaC,IAAIe,OAAJ,CAAYxB,KAAzB,CAAP;AACAH,+BAAOC,EAAEU,UAAF,CAAaC,IAAIe,OAAJ,CAAYR,YAAzB,CAAP;AACAnB,+BAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaC,SAApB,CAAjB,EAAiD,EAAjD;AACApC,+BAAOe,KAAP,CAAaH,IAAIe,OAAJ,CAAY,IAAZ,EAAkB,CAAlB,EAAqBE,EAArB,CAAb,EAAuC,EAAvC;AACAD,6BAAK,GAAL;AACA5B,+BAAOe,KAAP,CAAaH,IAAIe,OAAJ,CAAY,IAAZ,EAAkB,CAAlB,EAAqBI,GAArB,CAAb,EAAwC,EAAxC;AACA/B,+BAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaC,SAApB,CAAjB,EAAiD,CAAC,cAAD,EAAiB,cAAjB,CAAjD;AAnBA;AAoBH,iBApBD,SAqBQ;AACJxB,wBAAIK,OAAJ;AACH;AACJ,aA9BD;AA+BH,SAhCD;;AAkCAZ,iBAAS,OAAT,EAAkB,YAAY;AAC1BI,eAAG,8BAAH,EAAmC,UAAUS,IAAV,EAAgB;AAC/C,oBAAMN,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BqB,6BAAS,CAAC,KAAD,EAAQ,CAAC,OAAD,EAAU,QAAV,EAAoB,SAApB,CAAR;AADoB,iBAArB,CAAZ;;AAIA,oBAAI;AACA,wBAAME,KAAK,IAAIjC,QAAJ,CACP,KADO,EACA,CAACL,IAAIkC,KAAJ,CAAUC,KAAX,EAAkB,QAAlB,CADA,EAEP,UAAUA,KAAV,EAAiBI,MAAjB,EAAyB;AACrB,+BAAOJ,QAAQI,MAAR,GAAiB,GAAxB;AACH,qBAJM,CAAX;;AAMA9B,2BAAOC,EAAEU,UAAF,CAAaC,IAAIe,OAAjB,CAAP;AACA3B,2BAAOC,EAAEU,UAAF,CAAaC,IAAIe,OAAJ,CAAYxB,KAAzB,CAAP;AACAH,2BAAOC,EAAEU,UAAF,CAAaC,IAAIe,OAAJ,CAAYR,YAAzB,CAAP;AACAnB,2BAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaC,SAApB,CAAjB,EAAiD,EAAjD;AACAxB,wBAAIe,OAAJ,CAAYxB,KAAZ,CAAkB,IAAlB,EAAwB,CAAxB,EAA2B0B,EAA3B,EAA+B,UAACT,GAAD,EAAMC,GAAN,EAAc;AACzCC,qCAAa;AAAA,mCAAMV,IAAIK,OAAJ,EAAN;AAAA,yBAAb;AACA,4BAAIG,GAAJ,EAAS;AACLF,iCAAKE,GAAL;AACH;AACD,4BAAI;AACApB,mCAAOe,KAAP,CAAaM,GAAb,EAAkB,EAAlB;AACArB,mCAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaC,SAApB,CAAjB,EAAiD,CAAC,cAAD,CAAjD;AACAlB;AACH,yBAJD,CAKA,OAAOE,GAAP,EAAY;AACRF,iCAAKE,GAAL;AACH;AACJ,qBAbD;AAcH,iBAzBD,CA0BA,OAAOA,GAAP,EAAY;AACRR,wBAAIK,OAAJ;AACAC,yBAAKE,GAAL;AACH;AACJ,aAnCD;AAoCH,SArCD;AAsCH,KAzED;;AA2EAf,aAAS,OAAT,EAAkB,YAAY;AAC1B,YAAIO,YAAJ;AACA,YAAIyB,iBAAJ;AACA9B,eAAO,YAAY;AACf8B,uBAAW,IAAI7C,SAAJ,CAAc,KAAd,CAAX;AACAoB,kBAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AACvBgC,6BAAa,CAAE,MAAF,EAAU,CAAED,QAAF,CAAV;AADU,aAArB,CAAN;AAGH,SALD;;AAOA5B,WAAG,mBAAH,EAAwB,YAAY;AAChC,gBAAMY,MAAMT,IAAI0B,WAAJ,CAAgB,IAAID,QAAJ,CAAa,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAb,CAAhB,CAAZ;AACArC,mBAAO,CAACqB,GAAR;AACH,SAHD;;AAKAZ,WAAG,cAAH,EAAmB,YAAY;AAC3BT,mBAAOY,IAAI0B,WAAJ,CAAgB,IAAhB,CAAP;AACH,SAFD;AAGH,KAlBD;;AAoBAjC,aAAS,kBAAT,EAA6B,YAAY;AACrCI,WAAG,cAAH,EAAmB,YAAY;AAC3B,gBAAM8B,gBAAgB,IAAI7C,UAAJ,CAAe;AACjC8C,wBAAQ,IAAIhD,SAAJ,CAAcD,IAAIkC,KAAJ,CAAUgB,IAAxB,EAA8B,CAA9B,CADyB;AAEjCC,uBAAO;AAF0B,aAAf,CAAtB;AAIA,gBAAMC,iBAAiB,IAAInD,SAAJ,CAAc+C,aAAd,CAAvB;AACA,gBAAM3B,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BsC,kCAAkB,CAAE,MAAF,EAAU,CAAED,cAAF,EAAkB,MAAlB,CAAV;AADW,aAArB,CAAZ;AAGA3C,mBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaU,OAApB,CAAjB,EAA+C,CAAC,aAAD,CAA/C;AACA7C,mBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaW,MAApB,CAAjB,EAA8C,EAA9C;;AAEA,gBAAI;AACA,oBAAMC,UAAU,IAAIJ,cAAJ,CAAmB,CAC/B;AACID,2BAAO,CADX;AAEIF,4BAAQ,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,EAAa,CAAb;AAFZ,iBAD+B,EAK/B,IAAID,aAAJ,CAAkB;AACdG,2BAAO,CADO;AAEdF,4BAAQ,CAAC,CAAC,CAAF,EAAK,CAAC,CAAN,EAAS,CAAC,CAAV,EAAa,CAAC,CAAd,EAAiB,CAAC,CAAlB;AAFM,iBAAlB,CAL+B,CAAnB,CAAhB;;AAWA5B,oBAAIgC,gBAAJ,CAAqBG,OAArB,EAA8B,CAA9B;AACA/C,uBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaU,OAApB,CAAjB,EAA+C,CAAC,aAAD,CAA/C;AACA7C,uBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaW,MAApB,CAAjB,EAA8C,EAA9C;;AAEA9C,uBAAOe,KAAP,CAAagC,QAAQC,GAAR,CAAY,CAAZ,EAAeN,KAA5B,EAAmC,CAAnC;AACA1C,uBAAOe,KAAP,CAAagC,QAAQC,GAAR,CAAY,CAAZ,EAAeN,KAA5B,EAAmC,CAAnC;;AAEA,qBAAK,IAAIO,IAAI,CAAb,EAAgBA,IAAI,CAApB,EAAuBA,GAAvB,EAA4B;AACxBjD,2BAAOe,KAAP,CAAagC,QAAQC,GAAR,CAAY,CAAZ,EAAeR,MAAf,CAAsBQ,GAAtB,CAA0BC,CAA1B,CAAb,EAA2CA,IAAI,CAA/C;AACAjD,2BAAOe,KAAP,CAAagC,QAAQC,GAAR,CAAY,CAAZ,EAAeR,MAAf,CAAsBQ,GAAtB,CAA0BC,CAA1B,CAAb,EAA2C,CAAC,CAAD,GAAKA,CAAhD;AACH;AACJ,aAvBD,SAwBQ;AACJrC,oBAAIK,OAAJ;AACH;AACJ,SAvCD;AAwCH,KAzCD;;AA2CAZ,aAAS,cAAT,EAAyB,YAAY;AACjCI,WAAG,cAAH,EAAmB,YAAY;AAC3B,gBAAMyC,SAAS,IAAIzD,SAAJ,CAAc;AACzB0D,mBAAG,OADsB;AAEzBC,mBAAG,OAFsB;AAGzBC,mBAAG;AAHsB,aAAd,CAAf;AAKA,gBAAMC,eAAe,IAAI5D,UAAJ,CAAe;AAChC6D,qBAAK,MAD2B;AAEhCC,sBAAMN;AAF0B,aAAf,CAArB;AAIA,gBAAMtC,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BmD,yCAAyB,CAAE,OAAF,EAAW,CAAElE,IAAImE,OAAJ,CAAYJ,YAAZ,CAAF,CAAX;AADI,aAArB,CAAZ;AAGAtD,mBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAawB,MAApB,CAAjB,EAA8C,EAA9C;AACA3D,mBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaU,OAApB,CAAjB,EAA+C,CAAC,aAAD,CAA/C;;AAEA,gBAAI;AACA,oBAAIe,SAAS,IAAIN,YAAJ,CAAiB;AAC1BC,yBAAK,IAAIM,UAAJ,CAAe,CAAf,CADqB;AAE1BL,0BAAM,EAAEJ,GAAG,EAAL;AAFoB,iBAAjB,CAAb;;AAKApD,uBAAOC,EAAES,QAAF,CAAWkD,MAAX,CAAP;AACA5D,uBAAOe,KAAP,CAAa6C,OAAOL,GAApB,EAAyB,IAAIM,UAAJ,CAAe,CAAf,CAAzB;AACA7D,uBAAOe,KAAP,CAAa6C,OAAOJ,IAAP,CAAYJ,CAAzB,EAA4B,EAA5B;;AAEA,oBAAIU,SAASlD,IAAI6C,uBAAJ,CAA4BG,OAAOrE,GAAP,EAA5B,CAAb;AACAS,uBAAOe,KAAP,CAAa+C,MAAb,EAAqB,EAArB;;AAEAF,yBAAS,IAAIN,YAAJ,CAAiB;AACtBC,yBAAK,IAAIM,UAAJ,CAAe,CAAf,CADiB;AAEtBL,0BAAM,IAAIN,MAAJ,CAAW,EAAEE,GAAG,EAAL,EAAX;AAFgB,iBAAjB,CAAT;;AAKApD,uBAAOC,EAAES,QAAF,CAAWkD,MAAX,CAAP;AACA5D,uBAAOe,KAAP,CAAa6C,OAAOL,GAApB,EAAyB,IAAIM,UAAJ,CAAe,CAAf,CAAzB;AACA7D,uBAAOe,KAAP,CAAa6C,OAAOJ,IAAP,CAAYJ,CAAzB,EAA4B,EAA5B;;AAEAU,yBAASlD,IAAI6C,uBAAJ,CAA4BG,OAAOrE,GAAP,EAA5B,CAAT;AACAS,uBAAOe,KAAP,CAAa+C,MAAb,EAAqB,EAArB;;AAEA9D,uBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAawB,MAApB,CAAjB,EAA8C,EAA9C;AACA3D,uBAAOiC,SAAP,CAAiBhC,EAAEiC,IAAF,CAAOtB,IAAIuB,QAAJ,CAAaU,OAApB,CAAjB,EAA+C,CAAC,aAAD,CAA/C;AACH,aA3BD,SA4BQ;AACJjC,oBAAIK,OAAJ;AACH;AACJ,SA/CD;AAgDH,KAjDD;;AAmDAZ,aAAS,MAAT,EAAiB,YAAY;AACzBI,WAAG,mEAAH,EAAwE,YAAY;AAChF,gBAAMsD,cAAc,IAAIrE,UAAJ,CAAe;AAC/BsE,mCAAmB,MADY;AAE/BC,sCAAsB;AAFS,aAAf,CAApB;AAIA,gBAAMxC,QAAQ;AACVyC,yBAAS3E,IAAImE,OAAJ,CAAY,MAAZ,CADC;AAEVS,0BAAU5E,IAAIkC,KAAJ,CAAU2C,MAFV;AAGVC,+BAAe9E,IAAIkC,KAAJ,CAAU6C,IAHf;AAIVC,kCAAkB,IAAI/E,SAAJ,CAAcuE,WAAd;AAJR,aAAd;AAMA,gBAAMnD,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BkE,4CACA,CAAC,KAAD,EACI,CAAC/C,MAAMyC,OAAP,EACAzC,MAAM0C,QADN,EAEA1C,MAAM4C,aAFN,EAGA,MAHA,EAIA5C,MAAM8C,gBAJN,EAKAhF,IAAImE,OAAJ,CAAY,MAAZ,CALA,CADJ;AAF6B,aAArB,CAAZ;;AAWA,gBAAMc,6BAA6B5D,IAAI4D,0BAAvC;AACAxE,mBAAOC,EAAEU,UAAF,CAAa6D,0BAAb,CAAP;;AAEA,gBAAMC,aAAalF,IAAImF,KAAJ,CAAU,MAAV,CAAnB;AACA,gBAAMC,SAASpF,IAAImF,KAAJ,CAAU,MAAV,CAAf;AACA,gBAAMrD,MAAMmD,2BAA2BG,MAA3B,EAAmC,EAAnC,EAAuC,IAAvC,EAA6C,CAA7C,EAAgD,IAAhD,EAAsDF,UAAtD,CAAZ;;AAEAzE,mBAAOe,KAAP,CAAa0D,WAAWG,KAAX,EAAb,EAAiC,EAAjC;AACA5E,mBAAOe,KAAP,CAAaM,GAAb,EAAkB,IAAlB;AACH,SA/BD;;AAiCAhB,iBAAS,QAAT,EAAmB,YAAY;AAC3BI,eAAG,uCAAH,EAA4C,YAAY;AACpD,oBAAMG,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7BuE,gCAAY,CAAC,MAAD,EAAS,CAACtF,IAAIkC,KAAJ,CAAUqD,OAAX,EAAoB,MAApB,EAA4B,MAA5B,CAAT,CADiB;AAE7BC,8BAAU,CAAC,MAAD,EAAS,CAAC,QAAD,EAAW,MAAX,CAAT;AAFmB,iBAArB,CAAZ;;AAKA,oBAAMF,aAAajE,IAAIiE,UAAvB;AACA7E,uBAAOC,EAAEU,UAAF,CAAakE,UAAb,CAAP;AACA,oBAAME,WAAWnE,IAAImE,QAArB;AACA/E,uBAAOC,EAAEU,UAAF,CAAaoE,QAAb,CAAP;;AAEA,oBAAMC,MAAMzF,IAAI0F,YAAJ,CAAiB,MAAjB,CAAZ;AACAJ,2BAAWG,GAAX,EAAgB,CAAhB,EAAmB,IAAInB,UAAJ,CAAe,CAAf,CAAnB;AACA,oBAAIqB,SAAS3F,IAAIyB,WAAJ,CAAgBgE,GAAhB,CAAb;AACAhF,uBAAOe,KAAP,CAAamE,MAAb,EAAqB,MAArB;AACAlF,uBAAOe,KAAP,CAAagE,SAASC,GAAT,EAAc,CAAd,CAAb,EAA+B,IAAInB,UAAJ,CAAe,CAAf,CAA/B;AACA7D,uBAAOe,KAAP,CAAagE,SAAS,KAAT,EAAgB,CAAhB,CAAb,EAAiC,IAAIlB,UAAJ,CAAe,CAAf,CAAjC;AACH,aAjBD;;AAmBApD,eAAG,mCAAH,EAAwC,YAAY;AAChD,oBAAM0E,cAAc,IAAI3F,SAAJ,CAAc,QAAd,CAApB;AACA,oBAAMoB,MAAMvB,IAAIM,OAAJ,CAAYW,OAAZ,EAAqB;AAC7B8E,mCAAe,CAAC,MAAD,EAAS,CAACD,WAAD,EAAc,MAAd,EAAsB,QAAtB,CAAT;AADc,iBAArB,CAAZ;;AAIA,oBAAMC,gBAAgBxE,IAAIwE,aAA1B;AACApF,uBAAOC,EAAEU,UAAF,CAAayE,aAAb,CAAP;;AAEA,oBAAMC,MAAM,IAAIF,WAAJ,CAAgB,CAAhB,CAAZ;AACAE,oBAAIC,GAAJ,CAAQ,CAAR,EAAW,MAAX;AACAD,oBAAIC,GAAJ,CAAQ,CAAR,EAAW,OAAX;AACAD,oBAAIC,GAAJ,CAAQ,CAAR,EAAW,MAAX;AACA,oBAAMC,MAAM,IAAIC,MAAJ,CAAW,GAAX,CAAZ;AACAD,oBAAIE,IAAJ,CAAS,CAAT;;AAEAL,8BAAcC,GAAd,EAAmBA,IAAIK,MAAvB,EAA+BH,GAA/B;AACAvF,uBAAOe,KAAP,CAAaxB,IAAIyB,WAAJ,CAAgBuE,GAAhB,CAAb,EAAmC,eAAnC;AACH,aAlBD;AAmBH,SAvCD;AAwCH,KA1ED;AA2EH,CA3XD","file":"ffiCompatibility.js","sourcesContent":["/*\r\nCopyright 2016 Gábor Mező (gabor.mezo@outlook.com)\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\n'use strict';\r\nconst ffi = require('../../lib').ffi;\r\nconst ref = ffi.ref;\r\nconst ArrayType = ffi.ArrayType;\r\nconst UnionType = ffi.UnionType;\r\nconst StructType = ffi.StructType;\r\nconst Library = ffi.Library;\r\nconst Callback = ffi.Callback;\r\nconst FfiFunction = ffi.Function;\r\nconst helpers = require('./helpers');\r\nconst assert = require('assert');\r\nconst _ = require('lodash');\r\nconst Promise = require('bluebird');\r\nconst async = Promise.coroutine;\r\n\r\ndescribe('ffi compatibility', function () {\r\n    let libPath = null;\r\n    before(async(function* () {\r\n        libPath = yield helpers.findTestlib();\r\n    }));\r\n\r\n    it('supports required interface', function () {\r\n        assert(_.isObject(ffi));\r\n        assert(_.isObject(ref));\r\n        assert(_.isFunction(ArrayType));\r\n        assert(_.isFunction(UnionType));\r\n        assert(_.isFunction(StructType));\r\n        assert(_.isFunction(Library));\r\n        assert(_.isFunction(Callback));\r\n    });\r\n\r\n    describe('functions', function () {\r\n        it('supports multiple function definition', function () {\r\n            const lib = ffi.Library(libPath, {\r\n                mul: [ 'int', [ 'int', 'int' ]],\r\n                getString: [ 'char*', [] ]\r\n            });\r\n\r\n            try {\r\n                assert(_.isFunction(lib.mul));\r\n                assert.equal(lib.mul(21, 2), 42);\r\n                assert.equal(ref.readCString(lib.getString()), 'world');\r\n            }\r\n            finally {\r\n                lib.release();\r\n            }\r\n        });\r\n\r\n        describe('async', function () {\r\n            it('supported explicitly', function (done) {\r\n                const lib = ffi.Library(libPath, {\r\n                    mul: [ 'int', [ 'int', 'int' ]]\r\n                });\r\n\r\n                try {\r\n                    assert(_.isFunction(lib.mul));\r\n                    assert(_.isFunction(lib.mul.async));\r\n                    assert(_.isFunction(lib.mul.asyncPromise));\r\n                    lib.mul.async(21, 2, (err, res) => {\r\n                        setImmediate(() => lib.release());\r\n                        if (err) {\r\n                            done(err);\r\n                        }\r\n                        try {\r\n                            assert.equal(res, 42);\r\n                            done();\r\n                        }\r\n                        catch (err) {\r\n                            done(err);\r\n                        }\r\n                    });\r\n                }\r\n                catch (err) {\r\n                    lib.release();\r\n                    done(err);\r\n                }\r\n            });\r\n\r\n            it('supported in options', function (done) {\r\n                const lib = ffi.Library(\r\n                    libPath, \r\n                    {\r\n                        mul: [ 'int', [ 'int', 'int' ]]\r\n                    },\r\n                    {\r\n                        async: true\r\n                    });\r\n\r\n                try {\r\n                    assert(_.isFunction(lib.mul));\r\n                    assert(_.isUndefined(lib.mul.async));\r\n                    assert(_.isFunction(lib.mul.asyncPromise));\r\n                    lib.mul(21, 2, (err, res) => {\r\n                        setImmediate(() => lib.release());\r\n                        if (err) {\r\n                            done(err);\r\n                        }\r\n                        try {\r\n                            assert.equal(res, 42);\r\n                            done();\r\n                        }\r\n                        catch (err) {\r\n                            done(err);\r\n                        }\r\n                    });\r\n                }\r\n                catch (err) {\r\n                    lib.release();\r\n                    done(err);\r\n                }\r\n            });\r\n        });\r\n\r\n        it('supports promises', async(function* () {\r\n            const lib = ffi.Library(libPath, {\r\n                mul: [ 'int', [ 'int', 'int' ]]\r\n            });\r\n\r\n            try {\r\n                assert(_.isFunction(lib.mul));\r\n                assert(_.isFunction(lib.mul.async));\r\n                assert(_.isFunction(lib.mul.asyncPromise));\r\n                assert.equal(yield lib.mul.asyncPromise(21, 2), 42);\r\n            }\r\n            finally {\r\n                lib.release();\r\n            }\r\n        }));\r\n    });\r\n\r\n    describe('callback', function () {\r\n        describe('sync', function () {\r\n            it('supports ffi-style callbacks', function () {\r\n                const cbFunc = new FfiFunction('int', [ref.types.float, 'double']);\r\n                const lib = ffi.Library(libPath, {\r\n                    makeInt: ['int', ['float', 'double', cbFunc] ]\r\n                });\r\n\r\n                try {\r\n                    let v = 0.1;\r\n                    const cb = new Callback(\r\n                        'int', [ref.types.float, 'double'],\r\n                        function (float, double) {\r\n                            return float + double + v; \r\n                        });\r\n\r\n                    const cb2 = cbFunc.toPointer(function (float, double) {\r\n                        return float + double + v; \r\n                    });\r\n                    \r\n                    assert(_.isFunction(lib.makeInt));\r\n                    assert(_.isFunction(lib.makeInt.async));\r\n                    assert(_.isFunction(lib.makeInt.asyncPromise));\r\n                    assert.deepEqual(_.keys(lib._library.callbacks), []);\r\n                    assert.equal(lib.makeInt(19.9, 2, cb), 42);\r\n                    v += 0.1;\r\n                    assert.equal(lib.makeInt(19.9, 2, cb2), 44);\r\n                    assert.deepEqual(_.keys(lib._library.callbacks), ['FFICallback0', 'FFICallback1']);\r\n                }\r\n                finally {\r\n                    lib.release();\r\n                }\r\n            });\r\n        });\r\n\r\n        describe('async', function () {\r\n            it('supports ffi-style callbacks', function (done) {\r\n                const lib = ffi.Library(libPath, {\r\n                    makeInt: ['int', ['float', 'double', 'pointer'] ]\r\n                });\r\n\r\n                try {\r\n                    const cb = new Callback(\r\n                        'int', [ref.types.float, 'double'],\r\n                        function (float, double) {\r\n                            return float + double + 0.1; \r\n                        });\r\n\r\n                    assert(_.isFunction(lib.makeInt));\r\n                    assert(_.isFunction(lib.makeInt.async));\r\n                    assert(_.isFunction(lib.makeInt.asyncPromise));\r\n                    assert.deepEqual(_.keys(lib._library.callbacks), []);\r\n                    lib.makeInt.async(19.9, 2, cb, (err, res) => {\r\n                        setImmediate(() => lib.release());\r\n                        if (err) {\r\n                            done(err);\r\n                        }\r\n                        try {\r\n                            assert.equal(res, 42);\r\n                            assert.deepEqual(_.keys(lib._library.callbacks), ['FFICallback0']);\r\n                            done();\r\n                        }\r\n                        catch (err) {\r\n                            done(err);\r\n                        }\r\n                    });\r\n                }\r\n                catch (err) {\r\n                    lib.release();\r\n                    done(err);\r\n                }\r\n            });\r\n        });\r\n    });\r\n\r\n    describe('array', function () {\r\n        let lib;\r\n        let IntArray;\r\n        before(function () {\r\n            IntArray = new ArrayType('int');\r\n            lib = ffi.Library(libPath, {\r\n                isArrayNull: [ 'bool', [ IntArray ]]\r\n            });\r\n        });\r\n\r\n        it('accepts non nulls', function () {\r\n            const res = lib.isArrayNull(new IntArray([1, 2, 3]));\r\n            assert(!res);\r\n        });\r\n\r\n        it('accepts null', function () {\r\n            assert(lib.isArrayNull(null));\r\n        });\r\n    });\r\n\r\n    describe('array of structs', function () {\r\n        it('is supported', function () {\r\n            const TRecWithArray = new StructType({\r\n                values: new ArrayType(ref.types.long, 5),\r\n                index: 'uint',\r\n            });\r\n            const TRecWithArrays = new ArrayType(TRecWithArray);\r\n            const lib = ffi.Library(libPath, {\r\n                incRecWithArrays: [ 'void', [ TRecWithArrays, 'long' ]]\r\n            });\r\n            assert.deepEqual(_.keys(lib._library.structs), ['StructType0']);\r\n            assert.deepEqual(_.keys(lib._library.arrays), []);\r\n            \r\n            try {\r\n                const records = new TRecWithArrays([\r\n                    {\r\n                        index: 4,\r\n                        values: [3, 4, 5, 6, 7]\r\n                    },\r\n                    new TRecWithArray({\r\n                        index: 5,\r\n                        values: [-3, -4, -5, -6, -7]\r\n                    })\r\n                ]);\r\n\r\n                lib.incRecWithArrays(records, 2);\r\n                assert.deepEqual(_.keys(lib._library.structs), ['StructType0']);\r\n                assert.deepEqual(_.keys(lib._library.arrays), []);\r\n\r\n                assert.equal(records.get(0).index, 5);\r\n                assert.equal(records.get(1).index, 6);\r\n\r\n                for (let i = 0; i < 5; i++) {\r\n                    assert.equal(records.get(0).values.get(i), i + 4);\r\n                    assert.equal(records.get(1).values.get(i), -2 - i);\r\n                }\r\n            }\r\n            finally {\r\n                lib.release();\r\n            }\r\n        });\r\n    });\r\n\r\n    describe('tagged union', function () {\r\n        it('is supported', function () {\r\n            const TUnion = new UnionType({\r\n                a: 'short',\r\n                b: 'int64',\r\n                c: 'long'\r\n            });\r\n            const TTaggedUnion = new StructType({\r\n                tag: 'char',\r\n                data: TUnion\r\n            });\r\n            const lib = ffi.Library(libPath, {\r\n                getValueFromTaggedUnion: [ 'int64', [ ref.refType(TTaggedUnion) ]]\r\n            });\r\n            assert.deepEqual(_.keys(lib._library.unions), []);\r\n            assert.deepEqual(_.keys(lib._library.structs), ['StructType0']);\r\n\r\n            try {\r\n                let struct = new TTaggedUnion({\r\n                    tag: 'b'.charCodeAt(0),\r\n                    data: { b: 42 }\r\n                });\r\n\r\n                assert(_.isObject(struct));\r\n                assert.equal(struct.tag, 'b'.charCodeAt(0));\r\n                assert.equal(struct.data.b, 42);\r\n\r\n                let result = lib.getValueFromTaggedUnion(struct.ref());\r\n                assert.equal(result, 42);\r\n\r\n                struct = new TTaggedUnion({\r\n                    tag: 'b'.charCodeAt(0),\r\n                    data: new TUnion({ b: 42 })\r\n                });\r\n\r\n                assert(_.isObject(struct));\r\n                assert.equal(struct.tag, 'b'.charCodeAt(0));\r\n                assert.equal(struct.data.b, 42);\r\n\r\n                result = lib.getValueFromTaggedUnion(struct.ref());\r\n                assert.equal(result, 42);\r\n\r\n                assert.deepEqual(_.keys(lib._library.unions), []);  \r\n                assert.deepEqual(_.keys(lib._library.structs), ['StructType0']);\r\n            }\r\n            finally {\r\n                lib.release();\r\n            }\r\n        });\r\n    });\r\n\r\n    describe('misc', function () {\r\n        it('should support OpenCL clGetSupportedImageFormats method interface', function () {\r\n            const ImageFormat = new StructType({\r\n                imageChannelOrder: 'uint',\r\n                imageChannelDataType: 'uint'\r\n            });\r\n            const types = {\r\n                Context: ref.refType('void'),\r\n                MemFlags: ref.types.uint64,\r\n                MemObjectType: ref.types.uint,\r\n                ImageFormatArray: new ArrayType(ImageFormat)\r\n            };\r\n            const lib = ffi.Library(libPath, {\r\n                clGetSupportedImageFormats: \r\n                ['int', \r\n                    [types.Context, \r\n                    types.MemFlags, \r\n                    types.MemObjectType, \r\n                    'uint', \r\n                    types.ImageFormatArray, \r\n                    ref.refType('uint')]]\r\n            });\r\n            \r\n            const clGetSupportedImageFormats = lib.clGetSupportedImageFormats;\r\n            assert(_.isFunction(clGetSupportedImageFormats));\r\n\r\n            const numFormats = ref.alloc('uint');\r\n            const handle = ref.alloc('void');\r\n            const res = clGetSupportedImageFormats(handle, 16, 4337, 0, null, numFormats);\r\n            \r\n            assert.equal(numFormats.deref(), 16);\r\n            assert.equal(res, 4337);\r\n        });\r\n\r\n        describe('string', function () {\r\n            it('should support \"string\" on interfaces', function () {\r\n                const lib = ffi.Library(libPath, {\r\n                    appendChar: ['void', [ref.types.CString, 'uint', 'char']],\r\n                    readChar: ['char', ['string', 'uint']]\r\n                });\r\n\r\n                const appendChar = lib.appendChar;\r\n                assert(_.isFunction(appendChar));\r\n                const readChar = lib.readChar;\r\n                assert(_.isFunction(readChar));\r\n\r\n                const str = ref.allocCString('bubu');\r\n                appendChar(str, 2, 'a'.charCodeAt(0));\r\n                let newStr = ref.readCString(str);\r\n                assert.equal(newStr, 'buau');\r\n                assert.equal(readChar(str, 2), 'a'.charCodeAt(0));\r\n                assert.equal(readChar('aba', 2), 'a'.charCodeAt(0));\r\n            });\r\n\r\n            it('should support array of \"strings\"', function () {\r\n                const StringArray = new ArrayType('string');\r\n                const lib = ffi.Library(libPath, {\r\n                    concatStrings: ['void', [StringArray, 'uint', 'string']]\r\n                });\r\n\r\n                const concatStrings = lib.concatStrings;\r\n                assert(_.isFunction(concatStrings));\r\n\r\n                const arr = new StringArray(3);\r\n                arr.set(0, 'bubu');\r\n                arr.set(1, 'kitty');\r\n                arr.set(2, 'fuck');\r\n                const out = new Buffer(100);\r\n                out.fill(0);\r\n\r\n                concatStrings(arr, arr.length, out);\r\n                assert.equal(ref.readCString(out), 'bubukittyfuck');\r\n            });\r\n        });\r\n    });\r\n});"]}