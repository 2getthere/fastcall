{"version":3,"sources":["lib/FastFunction.js"],"names":["_","require","assert","Promise","native","dyncall","dynload","defs","callMode","FunctionDefinition","util","verify","ref","FastFunction","library","def","ptr","isObject","sync","async","_ptr","_vm","_function","_other","findSymbol","_pLib","name","path","newCallVM","options","vmSize","_makeFunction","free","getFunction","initialize","_makeAsyncFunction","_makeSyncFunction","vmArgSetters","args","map","_findVMSetterFunc","arg","type","funcArgs","range","length","n","funcBody","i","Ctx","fn","vm","setVM","setVMAndReset","setter","callback","func","makePtr","cb","callerFunc","_makeCallerFunc","innerFunc","innerFuncArgs","concat","Function","err","Error","ctx","apply","arguments","function","hasPtrArg","Boolean","filter","indirection","head","ptrs","push","promisify","findFastcallFunc","isPtr","resultType","toFastcallName","isFunction","result","derefType","module","exports"],"mappings":"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","file":"FastFunction.js","sourcesContent":["'use strict';\nconst _ = require('lodash');\nconst assert = require('assert');\nconst Promise = require('bluebird');\nconst native = require('./native');\nconst dyncall = native.dyncall;\nconst dynload = native.dynload;\nconst defs = require('./defs');\nconst callMode = defs.callMode;\nconst FunctionDefinition = require('./FunctionDefinition');\nconst util = require('util');\nconst verify = require('./verify');\nconst ref = require('./TooTallNates/ref');\n\nclass FastFunction extends FunctionDefinition {\n    constructor(library, def, callMode, ptr) {\n        assert(_.isObject(library), '\"library\" is not an object.');\n        assert(callMode === defs.callMode.sync || callMode === defs.callMode.async, '\"callMode\" is invalid: ' + callMode);\n        super(library, def);\n        this.callMode = callMode;\n        this._ptr = ptr;\n        this._vm = null;\n        this._function = null;\n        this._other = null;\n    }\n\n    initialize() {\n        if (!this._ptr) {\n            this._ptr = dynload.findSymbol(this.library._pLib, this.name);\n        }\n        assert(this._ptr, `Symbol \"${ this.name }\" not found in library \"${ this.library.path }\".`);\n        this._vm = dyncall.newCallVM(this.library.options.vmSize);\n        this._function = this._makeFunction();\n    }\n\n    release() {\n        dyncall.free(this._vm);\n    }\n\n    getFunction() {\n        assert(this._function, this.name + ' is not initialized.');\n        return this._function;\n    }\n\n    sync() {\n        if (this.callMode === defs.callMode.sync) {\n            return this.getFunction();\n        }\n        if (!this._other) {\n            this._other = new FastFunction(this.library, this, defs.callMode.sync, this._ptr);\n            this._other.initialize();\n        }\n        return this._other.getFunction();\n    }\n\n    async() {\n        if (this.callMode === defs.callMode.async) {\n            return this.getFunction();\n        }\n        if (!this._other) {\n            this._other = new FastFunction(this.library, this, defs.callMode.async, this._ptr);\n            this._other.initialize();\n        }\n        return this._other.getFunction();\n    }\n\n    _makeFunction() {\n        if (this.callMode === defs.callMode.async) {\n            return this._makeAsyncFunction();\n        }\n        return this._makeSyncFunction();\n    }\n\n    _makeSyncFunction() {\n        const vmArgSetters = this.args.map(arg => this._findVMSetterFunc(arg.type));\n        const funcArgs = _.range(vmArgSetters.length).map(n => 'arg' + n);\n        let funcBody = 'this.setVM(this.vm);';\n        for (let i = 0; i < vmArgSetters.length; i++) {\n            funcBody += `this.argSetter${ i }(arg${ i });`;\n        }\n        funcBody += 'return this.callerFunc();';\n\n        class Ctx {\n            constructor(fn) {\n                this.vm = fn._vm;\n                this.setVM = dyncall.setVMAndReset;\n                let i = 0;\n                for (const setter of vmArgSetters) {\n                    if (setter.type.callback) {\n                        this['argSetter' + i++] =\n                            cb => setter.func(setter.type.callback.makePtr(cb));\n                    }\n                    else {\n                        this['argSetter' + i++] = setter.func;\n                    }\n                }\n                this.callerFunc = fn._makeCallerFunc();\n            }\n        }\n\n        let innerFunc;\n        try {\n            const innerFuncArgs = funcArgs.concat([funcBody]);\n            innerFunc = new Function(...innerFuncArgs);\n        }\n        catch (err) {\n            throw Error('Invalid function body: ' + funcBody);\n        }\n        const ctx = new Ctx(this);\n        const func = function () {\n            return innerFunc.apply(ctx, arguments);\n        };\n        func.function = this;\n        return func;\n    }\n\n    _makeAsyncFunction() {\n        const vmArgSetters = this.args.map(arg => this._findVMSetterFunc(arg.type));\n        const hasPtrArg = Boolean(_(vmArgSetters).filter(setter => setter.type.indirection > 1).head());\n        const funcArgs = _.range(vmArgSetters.length).map(n => 'arg' + n);\n        let funcBody = hasPtrArg ? 'var ptrs = [];' : '';\n        funcBody += 'this.setVM(this.vm);';\n        for (let i = 0; i < vmArgSetters.length; i++) {\n            const setter = vmArgSetters[i];\n            if (setter.type.indirection > 1) {\n                funcBody += `this.argSetter${ i }(arg${ i }, ptrs);`;\n            }\n            else {\n                funcBody += `this.argSetter${ i }(arg${ i });`;\n            }\n        }\n        if (hasPtrArg) {\n            funcBody += 'return this.callerFunc(this.vm).finally(() => ptrs = null);';\n        }\n        else {\n            funcBody += 'return this.callerFunc(this.vm);';\n        }\n\n        class Ctx {\n            constructor(fn) {\n                this.setVM = dyncall.setVM;\n                let i = 0;\n                for (const setter of vmArgSetters) {\n                    if (setter.type.indirection > 1) {\n                        this['argSetter' + i++] = (ptr, ptrs) => {\n                            let _ptr;\n                            if (setter.type.callback) {\n                                _ptr = setter.type.callback.makePtr(ptr);\n                            }\n                            else {\n                                _ptr = ptr;\n                            }\n                            ptrs.push(_ptr);\n                            setter.func(_ptr);\n                        };\n                    }\n                    else {\n                        this['argSetter' + i++] = setter.func;\n                    }\n                }\n                this.callerFunc = Promise.promisify(fn._makeCallerFunc());\n                this.vm = null;\n            }\n        }\n\n        const ctx = new Ctx(this);\n        const vmSize = this.library.options.vmSize;\n\n        let innerFunc;\n        try {\n            innerFunc = new Function(...funcArgs.concat([funcBody]));\n        }\n        catch (err) {\n            throw Error('Invalid function body: ' + funcBody);\n        }\n\n        const func = function () {\n            ctx.vm = dyncall.newCallVM(vmSize);\n            return innerFunc.apply(ctx, arguments);\n        };\n        func.function = this;\n        return func;\n    }\n\n    _findVMSetterFunc(type) {\n        return this.findFastcallFunc(dyncall, 'arg', type);\n    }\n\n    _makeCallerFunc() {\n        let name;\n        let isPtr = false;\n        let async = false;\n        if (this.resultType.indirection > 1) {\n            name = 'callPointer';\n            isPtr = true;\n        }\n        else {\n            name = 'call' + this.toFastcallName(this.resultType.name);\n        }\n        if (this.callMode === defs.callMode.async) {\n            name += 'Async';\n            async = true;\n        }\n\n        const func = dyncall[name];\n        verify(_.isFunction(func));\n\n        if (async) {\n            if (isPtr) {\n                return (vm, callback) => {\n                    func(vm, this._ptr, (err, result) => {\n                        if (err) {\n                            return callback(err);\n                        }\n                        result.type = ref.derefType(this.resultType);\n                        callback(null, result);\n                    });\n                }\n            }\n\n            return (vm, callback) => func(vm, this._ptr, callback);\n        }\n\n        if (isPtr) {\n            return () => {\n                const result = func(this._ptr);\n                result.type = ref.derefType(this.resultType);\n                return result;\n            }\n        }\n\n        return () => func(this._ptr);\n    }\n}\n\nmodule.exports = FastFunction;"]}