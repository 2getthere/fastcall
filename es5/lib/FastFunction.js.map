{"version":3,"sources":["../../lib/FastFunction.js"],"names":["_","require","assert","Promise","native","dyncall","dynload","defs","callMode","FunctionDefinition","util","verify","a","ert","ref","refHelpers","FastFunction","library","def","ptr","isObject","sync","async","_ptr","_vm","_function","_other","_type","function","findSymbol","_pLib","name","path","newCallVM","options","vmSize","_makeFunction","free","getFunction","initialize","_makeAsyncFunction","_makeSyncFunction","vmArgSetters","args","map","_findVMSetterFunc","arg","type","funcArgs","range","length","n","funcBody","i","synchronized","queued","Ctx","fn","vm","setVM","setVMAndReset","setter","specPtrDef","callback","struct","union","array","func","makePtr","value","isArrayType","_makeArrayPtr","isFunctionType","_makeCallbackPtr","isStringType","_makeStringPtr","callerFunc","_makeCallerFunc","innerFunc","innerFuncArgs","concat","Function","err","Error","ctx","apply","arguments","_initFunction","hasPtrArg","Boolean","filter","isPointerType","head","finallyCode","f","ptrs","push","promisify","self","Object","defineProperties","get","findFastcallFunc","isPtr","resultType","indirection","toFastcallName","isFunction","resultDerefType","derefType","result","_makePtr","Buffer","isString","makeStringBuffer","buffer","module","exports"],"mappings":"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","file":"FastFunction.js","sourcesContent":["/*\r\nCopyright 2016 Gábor Mező (gabor.mezo@outlook.com)\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\n'use strict';\r\nconst _ = require('lodash');\r\nconst assert = require('assert');\r\nconst Promise = require('bluebird');\r\nconst native = require('./native');\r\nconst dyncall = native.dyncall;\r\nconst dynload = native.dynload;\r\nconst defs = require('./defs');\r\nconst callMode = defs.callMode;\r\nconst FunctionDefinition = require('./FunctionDefinition');\r\nconst util = require('util');\r\nconst verify = require('./verify');\r\nconst a = verify.a;\r\nconst ert = verify.ert;\r\nconst ref = require('./ref-libs/ref');\r\nconst refHelpers = require('./refHelpers');\r\n\r\nclass FastFunction extends FunctionDefinition {\r\n    constructor(library, def, callMode, ptr) {\r\n        assert(_.isObject(library), '\"library\" is not an object.');\r\n        assert(callMode === defs.callMode.sync || callMode === defs.callMode.async, '\"callMode\" is invalid: ' + callMode);\r\n        super(library, def);\r\n        this.callMode = callMode;\r\n        this._ptr = ptr;\r\n        this._vm = null;\r\n        this._function = null;\r\n        this._other = null;\r\n        this._type.function = this;\r\n    }\r\n\r\n    initialize() {\r\n        if (!this._ptr) {\r\n            this._ptr = dynload.findSymbol(this.library._pLib, this.name);\r\n        }\r\n        assert(this._ptr, `Symbol \"${ this.name }\" not found in library \"${ this.library.path }\".`);\r\n        this._vm = dyncall.newCallVM(this.library.options.vmSize);\r\n        this._function = this._makeFunction();\r\n    }\r\n\r\n    release() {\r\n        dyncall.free(this._vm);\r\n    }\r\n\r\n    getFunction() {\r\n        assert(this._function, this.name + ' is not initialized.');\r\n        return this._function;\r\n    }\r\n\r\n    sync() {\r\n        if (this.callMode === defs.callMode.sync) {\r\n            return this.getFunction();\r\n        }\r\n        if (!this._other) {\r\n            this._other = new FastFunction(this.library, this, defs.callMode.sync, this._ptr);\r\n            this._other.initialize();\r\n        }\r\n        return this._other.getFunction();\r\n    }\r\n\r\n    async() {\r\n        if (this.callMode === defs.callMode.async) {\r\n            return this.getFunction();\r\n        }\r\n        if (!this._other) {\r\n            this._other = new FastFunction(this.library, this, defs.callMode.async, this._ptr);\r\n            this._other.initialize();\r\n        }\r\n        return this._other.getFunction();\r\n    }\r\n\r\n    _makeFunction() {\r\n        if (this.callMode === defs.callMode.async) {\r\n            return this._makeAsyncFunction();\r\n        }\r\n        return this._makeSyncFunction();\r\n    }\r\n\r\n    _makeSyncFunction() {\r\n        const vmArgSetters = this.args.map(arg => this._findVMSetterFunc(arg.type));\r\n        const funcArgs = _.range(vmArgSetters.length).map(n => 'arg' + n);\r\n        let funcBody = 'this.setVM(this.vm);';\r\n        for (let i = 0; i < vmArgSetters.length; i++) {\r\n            funcBody += `this.argSetter${ i }(arg${ i });`;\r\n        }\r\n        if (this.library.synchronized) {\r\n            funcBody += 'this.library._lock();';\r\n            funcBody += 'try {';\r\n            funcBody += 'return this.callerFunc();';\r\n            funcBody += '}';\r\n            funcBody += 'finally {';\r\n            funcBody += 'this.library._unlock();';\r\n            funcBody += '}';\r\n        }\r\n        else {\r\n            if (this.library.queued) {\r\n                funcBody += 'this.library._assertQueueEmpty();';\r\n            }\r\n            funcBody += 'return this.callerFunc();';\r\n        }\r\n\r\n        class Ctx {\r\n            constructor(fn) {\r\n                this.library = fn.library;\r\n                this.vm = fn._vm;\r\n                this.setVM = dyncall.setVMAndReset;\r\n                let i = 0;\r\n                for (const setter of vmArgSetters) {\r\n                    const specPtrDef = setter.type.callback ||\r\n                            setter.type.struct ||\r\n                            setter.type.union ||\r\n                            setter.type.array;\r\n                    if (specPtrDef) {\r\n                        this['argSetter' + i++] = value => {\r\n                            setter.func(specPtrDef.makePtr(value));\r\n                        }\r\n                    }\r\n                    else if (refHelpers.isArrayType(setter.type)) {\r\n                        this['argSetter' + i++] = value => {\r\n                            setter.func(FastFunction._makeArrayPtr(value));\r\n                        }\r\n                    }\r\n                    else if (refHelpers.isFunctionType(setter.type)) {\r\n                        this['argSetter' + i++] = value => {\r\n                            setter.func(fn._makeCallbackPtr(value));\r\n                        }\r\n                    }\r\n                    else if (refHelpers.isStringType(setter.type)) {\r\n                        this['argSetter' + i++] = value => {\r\n                            setter.func(fn._makeStringPtr(value));\r\n                        }\r\n                    }\r\n                    else {\r\n                        this['argSetter' + i++] = setter.func;\r\n                    }\r\n                }\r\n                this.callerFunc = fn._makeCallerFunc();\r\n            }\r\n        }\r\n\r\n        let innerFunc;\r\n        try {\r\n            const innerFuncArgs = funcArgs.concat([funcBody]);\r\n            innerFunc = new Function(...innerFuncArgs);\r\n        }\r\n        catch (err) {\r\n            throw Error('Invalid function body: ' + funcBody);\r\n        }\r\n        const ctx = new Ctx(this);\r\n        const func = function () {\r\n            return innerFunc.apply(ctx, arguments);\r\n        };\r\n        return this._initFunction(func);\r\n    }\r\n\r\n    _makeAsyncFunction() {\r\n        const vmArgSetters = this.args.map(arg => this._findVMSetterFunc(arg.type));\r\n        const hasPtrArg = Boolean(_(vmArgSetters).filter(setter => refHelpers.isPointerType(setter.type)).head());\r\n        const funcArgs = _.range(vmArgSetters.length).map(n => 'arg' + n);\r\n        let funcBody = hasPtrArg ? 'var ptrs = [];' : '';\r\n        funcBody += 'var myVM = this.vm;';\r\n        funcBody += 'this.setVM(myVM);';\r\n        for (let i = 0; i < vmArgSetters.length; i++) {\r\n            const setter = vmArgSetters[i];\r\n            if (refHelpers.isPointerType(setter.type)) {\r\n                funcBody += `this.argSetter${ i }(arg${ i }, ptrs);`;\r\n            }\r\n            else {\r\n                funcBody += `this.argSetter${ i }(arg${ i });`;\r\n            }\r\n        }\r\n\r\n        let finallyCode = '{';\r\n        if (this.library.synchronized) {\r\n            finallyCode += 'this.library._unlock();';\r\n            funcBody += 'this.library._lock();';\r\n        }\r\n        if (hasPtrArg) {\r\n            finallyCode += 'ptrs = null;';\r\n        }\r\n        finallyCode += '}';\r\n\r\n        const f = `return this.callerFunc(myVM).finally(() => ${ finallyCode });`;\r\n        if (this.library.queued) {\r\n            funcBody += `return this.library._enqueue(() => { ${ f } });`;\r\n        }\r\n        else {\r\n            funcBody += f;\r\n        }\r\n\r\n        class Ctx {\r\n            constructor(fn) {\r\n                this.library = fn.library;\r\n                this.setVM = dyncall.setVM;\r\n                this.free = dyncall.free;\r\n                let i = 0;\r\n                for (const setter of vmArgSetters) {\r\n                    if (refHelpers.isPointerType(setter.type)) {\r\n                        const specPtrDef = setter.type.callback ||\r\n                                setter.type.struct ||\r\n                                setter.type.union ||\r\n                                setter.type.array;\r\n                        if (specPtrDef) {\r\n                            this['argSetter' + i++] = (value, ptrs) => {\r\n                                const ptr = specPtrDef.makePtr(value);\r\n                                ptrs.push(ptr);\r\n                                setter.func(ptr);\r\n                            }\r\n                        }\r\n                        else if (refHelpers.isArrayType(setter.type)) {\r\n                            this['argSetter' + i++] = (value, ptrs) => {\r\n                                const ptr = FastFunction._makeArrayPtr(value);\r\n                                ptrs.push(ptr);\r\n                                setter.func(ptr);\r\n                            }\r\n                        }\r\n                        else if (refHelpers.isFunctionType(setter.type)) {\r\n                            this['argSetter' + i++] = (value, ptrs) => {\r\n                                const ptr = fn._makeCallbackPtr(value);\r\n                                ptrs.push(ptr);\r\n                                setter.func(ptr);\r\n                            }\r\n                        }\r\n                        else if (refHelpers.isStringType(setter.type)) {\r\n                            this['argSetter' + i++] = (value, ptrs) => {\r\n                                const ptr = fn._makeStringPtr(value);\r\n                                ptrs.push(ptr);\r\n                                setter.func(ptr);\r\n                            }\r\n                        }\r\n                        else {\r\n                            this['argSetter' + i++] = (value, ptrs) => {\r\n                                ptrs.push(value);\r\n                                setter.func(value);\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        this['argSetter' + i++] = setter.func;\r\n                    }\r\n                }\r\n                this.callerFunc = Promise.promisify(fn._makeCallerFunc());\r\n                this.vm = null;\r\n            }\r\n        }\r\n\r\n        const ctx = new Ctx(this);\r\n        const vmSize = this.library.options.vmSize;\r\n\r\n        let innerFunc;\r\n        try {\r\n            innerFunc = new Function(...funcArgs.concat([funcBody]));\r\n        }\r\n        catch (err) {\r\n            throw Error('Invalid function body: ' + funcBody);\r\n        }\r\n\r\n        const func = function () {\r\n            ctx.vm = dyncall.newCallVM(vmSize);\r\n            return innerFunc.apply(ctx, arguments);\r\n        };\r\n        return this._initFunction(func);\r\n    }\r\n\r\n    _initFunction(func) {\r\n        func.function = this;\r\n        func.type = this.type;\r\n        const self = this;\r\n        Object.defineProperties(func, {\r\n            sync: {\r\n                get: function () {\r\n                    return self.sync();\r\n                }\r\n            },\r\n            async: {\r\n                get: function () {\r\n                    return self.async();\r\n                }\r\n            }\r\n        });\r\n        return func;\r\n    }\r\n\r\n    _findVMSetterFunc(type) {\r\n        return this.findFastcallFunc(dyncall, 'arg', type);\r\n    }\r\n\r\n    _makeCallerFunc() {\r\n        let name;\r\n        let isPtr = false;\r\n        let async = false;\r\n        if (this.resultType.indirection > 1) {\r\n            name = 'callPointer';\r\n            isPtr = true;\r\n        }\r\n        else {\r\n            name = 'call' + this.toFastcallName(this.resultType.name);\r\n        }\r\n        if (this.callMode === defs.callMode.async) {\r\n            name += 'Async';\r\n            async = true;\r\n        }\r\n\r\n        const func = dyncall[name];\r\n        a&&ert(_.isFunction(func));\r\n\r\n        if (async) {\r\n            if (isPtr) {\r\n                const resultDerefType = ref.derefType(this.resultType);\r\n                return (vm, callback) => {\r\n                    func(vm, this._ptr, (err, result) => {\r\n                        if (err) {\r\n                            return callback(err);\r\n                        }\r\n                        result.type = resultDerefType;\r\n                        callback(null, result);\r\n                    });\r\n                }\r\n            }\r\n\r\n            return (vm, callback) => func(vm, this._ptr, callback);\r\n        }\r\n\r\n        if (isPtr) {\r\n            const resultDerefType = ref.derefType(this.resultType);\r\n            return () => {\r\n                const result = func(this._ptr);\r\n                result.type = resultDerefType;\r\n                return result;\r\n            }\r\n        }\r\n\r\n        return () => func(this._ptr);\r\n    }\r\n\r\n    static _makeArrayPtr(value) {\r\n        if (value === null) {\r\n            return null;\r\n        }\r\n        if (value.buffer) {\r\n            return value.buffer;\r\n        }\r\n        assert(value instanceof Buffer, 'Argument is not a Buffer.');\r\n        return value;\r\n    }\r\n\r\n    _makeCallbackPtr(value) {\r\n        if (value === null) {\r\n            return null;\r\n        }\r\n        if (value._makePtr) {\r\n            return value._makePtr(this.library);\r\n        }\r\n        assert(value instanceof Buffer, 'Argument is not a Buffer.');\r\n        return value;\r\n    }\r\n\r\n    _makeStringPtr(value) {\r\n        if (value === null) {\r\n            return null;\r\n        }\r\n        if (_.isString(value)) {\r\n            return native.makeStringBuffer(value);\r\n        }\r\n        assert(value instanceof Buffer, 'Argument is not a Buffer.');\r\n        return value;\r\n    }\r\n}\r\n\r\nmodule.exports = FastFunction;"]}