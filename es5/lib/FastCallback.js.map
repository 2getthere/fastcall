{"version":3,"sources":["lib/FastCallback.js"],"names":["_","require","assert","verify","native","util","FunctionDefinition","ref","FastCallback","library","def","isObject","_def","_ptrType","refType","types","void","_processArgs","_setResult","_execute","_makeExecuteMethod","factory","fn","makeCallbackPtr","callback","value","isFunction","ptr","makePtr","_loop","signature","execute","Buffer","TypeError","processArgsFunc","_makeProcessArgsFunc","setResultFunc","_findSetResultFunc","resultTypeCode","resultType","code","argsPtr","resultPtr","func","callArgs","Array","args","length","result","apply","processArgFuncs","map","_findProcessArgFunc","arg","type","funcArgs","funcBody","i","Ctx","processArgFunc","ctx","innerFunc","Function","concat","err","Error","arguments","findFastcallFunc","module","exports"],"mappings":"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","file":"FastCallback.js","sourcesContent":["'use strict';\nconst _ = require('lodash');\nconst assert = require('assert');\nconst verify = require('./verify');\nconst native = require('./native');\nconst util = require('util');\nconst FunctionDefinition = require('./FunctionDefinition');\nconst ref = require('./ref');\n\nclass FastCallback extends FunctionDefinition {\n    constructor(library, def) {\n        assert(_.isObject(library), '\"library\" is not an object.');\n        super(library, def);\n        this.library = library;\n        this._def = new FunctionDefinition(library, def);\n        this._ptrType = ref.refType(ref.types.void);\n        this._processArgs = null;\n        this._setResult = null;\n    }\n\n    initialize() {\n        this._execute = this._makeExecuteMethod();\n    }\n\n    get execute() {\n        assert(this._execute, 'FastCallback is not initialized.');\n        return this._execute;\n    }\n\n    getFactory() {\n        const factory = (fn) => this.makeCallbackPtr(fn);\n        factory.callback = this;\n        return factory;\n    }\n\n    makeCallbackPtr(value) {\n        if (value.callback === this) {\n            return value;\n        }\n        if (_.isFunction(value)) {\n            const ptr = native.callback.makePtr(this, this.library._loop, this.signature, this.execute, value);\n            verify(ptr.callback === this);\n            return ptr;\n        }\n        if (value instanceof Buffer) {\n            throw new TypeError('Buffer is not a callback pointer.');\n        }\n        throw new TypeError('Cannot make callback from: ' + value);\n    }\n\n    _makeExecuteMethod() {\n        const processArgsFunc = this._makeProcessArgsFunc();\n        const setResultFunc = this._findSetResultFunc();\n        const resultTypeCode = this.resultType.code;\n        return (argsPtr, resultPtr, func) => {\n            const callArgs = new Array(this.args.length);\n            processArgsFunc(argsPtr, callArgs);\n            const result = func.apply(null, callArgs);\n            if (resultTypeCode !== 'v') {\n                setResultFunc(resultPtr, result);\n            }\n        };\n    }\n\n    _makeProcessArgsFunc() {\n        const processArgFuncs = this.args.map(arg => this._findProcessArgFunc(arg.type));\n        const funcArgs = ['argsPtr', 'callArgs'];\n        let funcBody = '';\n        for (let i = 0; i < processArgFuncs.length; i++) {\n            funcBody += `callArgs[${ i }] = this.processArgFunc${ i }(argsPtr);`;\n        }\n\n        class Ctx {\n            constructor(callback) {\n                let i = 0;\n                for (const processArgFunc of processArgFuncs) {\n                    this['processArgFunc' + i++] = processArgFunc.func;\n                }\n            }\n        }\n\n        const ctx = new Ctx(this);\n\n        let innerFunc;\n        try {\n            innerFunc = new Function(...funcArgs.concat([funcBody]));\n        }\n        catch (err) {\n            throw Error('Invalid function body: ' + funcBody);\n        }\n\n        const func = function () {\n            return innerFunc.apply(ctx, arguments);\n        };\n        func.callback = this;\n        return func;\n    }\n\n     _findProcessArgFunc(type) {\n        return this.findFastcallFunc(native.callback, 'arg', type);\n    }\n\n    _findSetResultFunc() {\n        return this.findFastcallFunc(native.callback, 'set', this.resultType).func;\n    }\n}\n\nmodule.exports = FastCallback;"]}