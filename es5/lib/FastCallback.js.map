{"version":3,"sources":["../../lib/FastCallback.js"],"names":["_","require","assert","verify","native","util","FunctionDefinition","ref","FastCallback","library","def","isObject","_def","_processArgs","_setResult","_type","callback","_execute","_makeExecuteMethod","factory","makePtr","value","type","isFunction","ptr","_loop","signature","execute","Buffer","undefined","TypeError","processArgsFunc","_makeProcessArgsFunc","setResultFunc","_findSetResultFunc","resultTypeCode","resultType","code","argsPtr","resultPtr","func","callArgs","Array","args","length","result","apply","processArgFuncs","map","_findProcessArgFunc","arg","funcArgs","funcBody","i","Ctx","processArgFunc","ctx","innerFunc","Function","concat","err","Error","arguments","findFastcallFunc","module","exports"],"mappings":"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","file":"FastCallback.js","sourcesContent":["'use strict';\nconst _ = require('lodash');\nconst assert = require('assert');\nconst verify = require('./verify');\nconst native = require('./native');\nconst util = require('util');\nconst FunctionDefinition = require('./FunctionDefinition');\nconst ref = require('./ref-libs/ref');\n\nclass FastCallback extends FunctionDefinition {\n    constructor(library, def) {\n        assert(_.isObject(library), '\"library\" is not an object.');\n        super(library, def);\n        this.library = library;\n        this._def = new FunctionDefinition(library, def);\n        this._processArgs = null;\n        this._setResult = null;\n        this._type.callback = this;\n    }\n\n    initialize() {\n        this._execute = this._makeExecuteMethod();\n    }\n\n    get execute() {\n        assert(this._execute, 'FastCallback is not initialized.');\n        return this._execute;\n    }\n\n    getFactory() {\n        const factory = value => this.makePtr(value);\n        factory.callback = this;\n        factory.type = this.type;\n        return factory;\n    }\n\n    makePtr(value) {\n        if (value) {\n            if (value.callback === this) {\n                return value;\n            }\n            if (_.isFunction(value)) {\n                const ptr = native.callback.makePtr(this, this.library._loop, this.signature, this.execute, value);\n                verify(ptr.callback === this);\n                ptr.type = this.type;\n                return ptr;\n            }\n            if (value instanceof Buffer) {\n                if (value.type === undefined) {\n                    value.type = this.type;\n                    value.callback = this;\n                    return value;\n                }\n                throw new TypeError('Buffer is not a callback pointer.');\n            }\n        }\n        else if (value === null) {\n            return null;\n        }\n        throw new TypeError('Cannot make callback from: ' + value);\n    }\n\n    _makeExecuteMethod() {\n        const processArgsFunc = this._makeProcessArgsFunc();\n        const setResultFunc = this._findSetResultFunc();\n        const resultTypeCode = this.resultType.code;\n        return (argsPtr, resultPtr, func) => {\n            const callArgs = new Array(this.args.length);\n            processArgsFunc(argsPtr, callArgs);\n            const result = func.apply(null, callArgs);\n            if (resultTypeCode !== 'v') {\n                setResultFunc(resultPtr, result);\n            }\n        };\n    }\n\n    _makeProcessArgsFunc() {\n        const processArgFuncs = this.args.map(arg => this._findProcessArgFunc(arg.type));\n        const funcArgs = ['argsPtr', 'callArgs'];\n        let funcBody = '';\n        for (let i = 0; i < processArgFuncs.length; i++) {\n            funcBody += `callArgs[${ i }] = this.processArgFunc${ i }(argsPtr);`;\n        }\n\n        class Ctx {\n            constructor(callback) {\n                let i = 0;\n                for (const processArgFunc of processArgFuncs) {\n                    this['processArgFunc' + i++] = processArgFunc.func;\n                }\n            }\n        }\n\n        const ctx = new Ctx(this);\n\n        let innerFunc;\n        try {\n            innerFunc = new Function(...funcArgs.concat([funcBody]));\n        }\n        catch (err) {\n            throw Error('Invalid function body: ' + funcBody);\n        }\n\n        const func = function () {\n            return innerFunc.apply(ctx, arguments);\n        };\n        func.callback = this;\n        return func;\n    }\n\n     _findProcessArgFunc(type) {\n        return this.findFastcallFunc(native.callback, 'arg', type);\n    }\n\n    _findSetResultFunc() {\n        return this.findFastcallFunc(native.callback, 'set', this.resultType).func;\n    }\n}\n\nmodule.exports = FastCallback;"]}