{"version":3,"sources":["../../lib/Library.js"],"names":["_","require","native","assert","Promise","async","coroutine","fs","promisifyAll","path","defs","FastFunction","FastCallback","FastStruct","FastUnion","FastArray","verify","a","ert","queue","NameFactory","Parser","defaultOptions","defaultCallMode","callMode","sync","syncMode","none","vmSize","Library","options","isString","length","Object","freeze","defaults","_pLib","_initialized","_released","_loop","_mutex","_queue","_nameFactory","functions","callbacks","structs","unions","arrays","interface","dynload","loadLibrary","callback","newLoop","lock","mutex","newMutex","Buffer","values","func","release","freeLoop","freeLibrary","str","parseMultiline","def","syncFunction","asyncFunction","_addFunction","_addCallback","_addStruct","_addUnion","_addArray","type","name","initialize","getFunction","cb","getFactory","struct","union","array","unlock","f","next","prefix","makeName","moduleDir","doFind","module","exports","rootDir","join","findIn","libPath","Error","subDir","dir","files","readdirAsync","rex","RegExp","file","test"],"mappings":"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","file":"Library.js","sourcesContent":["/*\r\nCopyright 2016 Gábor Mező (gabor.mezo@outlook.com)\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\n'use strict';\r\nconst _ = require('lodash');\r\nconst native = require('./native');\r\nconst assert = require('assert');\r\nconst Promise = require('bluebird');\r\nconst async = Promise.coroutine;\r\nconst fs = Promise.promisifyAll(require('fs'));\r\nconst path = require('path');\r\nconst defs = require('./defs');\r\nconst FastFunction = require('./FastFunction');\r\nconst FastCallback = require('./FastCallback');\r\nconst FastStruct = require('./FastStruct');\r\nconst FastUnion = require('./FastUnion');\r\nconst FastArray = require('./FastArray');\r\nconst verify = require('./verify');\r\nconst a = verify.a;\r\nconst ert = verify.ert;\r\nconst queue = require('./queue');\r\nconst NameFactory = require('./NameFactory');\r\nconst Parser = require('./Parser');\r\n\r\nconst defaultOptions = {\r\n    defaultCallMode: defs.callMode.sync,\r\n    syncMode: defs.syncMode.none,\r\n    vmSize: 512\r\n};\r\n\r\nclass Library {\r\n    constructor(path, options) {\r\n        assert(_.isString(path) && path.length, 'Argument \"path\" should be a non-empty string.');\r\n        this.path = path;\r\n        this.options = Object.freeze(_.defaults(options, defaultOptions));\r\n        assert(this.options.defaultCallMode === defs.callMode.sync ||\r\n            this.options.defaultCallMode === defs.callMode.async,\r\n            '\"options.callMode\" is invalid.');\r\n        assert(this.options.syncMode >= defs.syncMode.none && this.options.syncMode <= defs.syncMode.queue,\r\n            '\"options.syncMode\" is invalid.');\r\n        this._pLib = null;\r\n        this._initialized = false;\r\n        this._released = false;\r\n        this._loop = null;\r\n        this._mutex = null;\r\n        this._queue = null;\r\n        this._nameFactory = new NameFactory();\r\n        this.functions = {};\r\n        this.callbacks = {};\r\n        this.structs = {};\r\n        this.unions = {};\r\n        this.arrays = {};\r\n        this.interface = {};\r\n    }\r\n\r\n    get synchronized() {\r\n        return this.options.syncMode === defs.syncMode.lock;\r\n    }\r\n\r\n    get queued() {\r\n        return this.options.syncMode === defs.syncMode.queue;\r\n    }\r\n\r\n    initialize() {\r\n        assert(!this._released, `Library \"${ this.path }\" has already been released.`);\r\n        if (this._initialized) {\r\n            return;\r\n        }\r\n        this._pLib = native.dynload.loadLibrary(this.path);\r\n        this._loop = native.callback.newLoop();\r\n        if (this.options.syncMode === defs.syncMode.lock) {\r\n            this._mutex = native.mutex.newMutex();\r\n            a&&ert(this._mutex instanceof Buffer);\r\n            \r\n        }\r\n        this._initialized = true;\r\n        return this;\r\n    }\r\n\r\n    release() {\r\n        if (!this._initialized) {\r\n            return;\r\n        }\r\n        if (this._released) {\r\n            return;\r\n        }\r\n        for (const func of _.values(this.functions)) {\r\n            func.release();\r\n        }\r\n        native.callback.freeLoop(this._loop);\r\n        native.dynload.freeLibrary(this._pLib);\r\n        this._released = true;\r\n        return this;\r\n    }\r\n\r\n    declare(str) {\r\n        return new Parser(this).parseMultiline(str, null);\r\n    }\r\n\r\n    declareSync(str) {\r\n        return new Parser(this).parseMultiline(str, defs.callMode.sync);\r\n    }\r\n\r\n    declareAsync(str) {\r\n        return new Parser(this).parseMultiline(str, defs.callMode.async);\r\n    }\r\n\r\n    function(def) {\r\n        return this.options.defaultCallMode === defs.callMode.sync ?\r\n            this.syncFunction(def) :\r\n            this.asyncFunction(def);\r\n    }\r\n\r\n    syncFunction(def) {\r\n        this._addFunction(new FastFunction(this, def, defs.callMode.sync));\r\n        return this;\r\n    }\r\n\r\n    asyncFunction(def) {\r\n        this._addFunction(new FastFunction(this, def, defs.callMode.async));\r\n        return this;\r\n    }\r\n\r\n    callback(def) {\r\n        this._addCallback(new FastCallback(this, def));\r\n        return this;\r\n    }\r\n\r\n    struct(def) {\r\n        this._addStruct(new FastStruct(this, def));\r\n        return this;\r\n    }\r\n\r\n    union(def) {\r\n        this._addUnion(new FastUnion(this, def));\r\n        return this;\r\n    }\r\n\r\n    array(def) {\r\n        this._addArray(new FastArray(this, def));\r\n        return this;\r\n    }\r\n\r\n    findRefDeclaration(type) {\r\n        assert(_.isString(type), 'Argument is not a string.');\r\n        return this.structs[type] || this.unions[type] || this.arrays[type] || null;\r\n    }\r\n\r\n    _addFunction(func) {\r\n        assert(!this.functions[func.name], `Function ${ func.name } already declared.`);\r\n        this.initialize();\r\n        func.initialize();\r\n        this.functions[func.name] = func;\r\n        this.interface[func.name] = func.getFunction();\r\n    }\r\n\r\n    _addCallback(cb) {\r\n        assert(!this.callbacks[cb.name], `Callback ${ cb.name } already declared.`);\r\n        this.initialize();\r\n        cb.initialize();\r\n        this.callbacks[cb.name] = cb;\r\n        this.interface[cb.name] = cb.getFactory();\r\n    }\r\n\r\n    _addStruct(struct) {\r\n        assert(!this.structs[struct.name], `Union ${ struct.name } already declared.`);\r\n        this.initialize();\r\n        this.structs[struct.name] = struct;\r\n        this.interface[struct.name] = struct.getFactory();\r\n    }\r\n\r\n    _addUnion(union) {\r\n        assert(!this.unions[union.name], `Union ${ union.name } already declared.`);\r\n        this.initialize();\r\n        this.unions[union.name] = union;\r\n        this.interface[union.name] = union.getFactory();\r\n    }\r\n\r\n    _addArray(array) {\r\n        assert(!this.arrays[array.name], `Array ${ array.name } already declared.`);\r\n        this.initialize();\r\n        this.arrays[array.name] = array;\r\n        this.interface[array.name] = array.getFactory();\r\n    }\r\n\r\n    _lock() {\r\n        native.mutex.lock(this._mutex);\r\n    }\r\n\r\n    _unlock() {\r\n        native.mutex.unlock(this._mutex);\r\n    }\r\n\r\n    _assertQueueEmpty() {\r\n        assert(!queue.length, 'Calling functions synchronously is forbidden while there are asynchronous functions enqueued.');\r\n    }\r\n\r\n    _enqueue(f) {\r\n        return queue.next(f);\r\n    }\r\n\r\n    makeName(prefix) {\r\n        return this._nameFactory.makeName(prefix);\r\n    }\r\n\r\n    static get callMode() {\r\n        return defs.callMode;\r\n    }\r\n\r\n    static get syncMode() {\r\n        return defs.syncMode;\r\n    }\r\n\r\n    static find(moduleDir, name) {\r\n        return doFind(moduleDir, name);\r\n    }\r\n}\r\n\r\nmodule.exports = Library;\r\n\r\nvar doFind = async(function* (moduleDir, name) {\r\n    assert(_.isString(moduleDir), 'Agument is not a string.');\r\n\r\n    const rootDir = path.join(moduleDir, 'build');\r\n    const libPath =\r\n        (yield findIn(rootDir, 'Debug', name)) ||\r\n        (yield findIn(rootDir, 'Release', name));\r\n    if (!libPath) {\r\n        throw new Error(`${ name } library not found.`);\r\n    }\r\n    return libPath;\r\n});\r\n\r\nvar findIn = async(function* (rootDir, subDir, name) {\r\n    const dir = path.join(rootDir, subDir);\r\n    let files;\r\n    try {\r\n        files = yield fs.readdirAsync(dir);\r\n    }\r\n    catch (err) {\r\n        return null;\r\n    }\r\n    const rex = new RegExp(name);\r\n    for (const file of files) {\r\n        if (rex.test(file)) {\r\n            return path.join(dir, file);\r\n        }\r\n    }\r\n    return null;\r\n});"]}