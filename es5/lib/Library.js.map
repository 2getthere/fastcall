{"version":3,"sources":["lib/Library.js"],"names":["_","require","native","assert","Promise","async","coroutine","fs","promisifyAll","path","defs","callMode","FastFunction","FastCallback","defaultOptions","defaultCallMode","sync","vmSize","Library","options","isString","length","Object","freeze","defaults","_pLib","_initialized","_released","_loop","functions","callbacks","interface","dynload","loadLibrary","callback","newLoop","values","func","release","freeLoop","freeLibrary","def","syncFunction","asyncFunction","_addFunction","_addCallback","name","initialize","getFunction","cb","getFactory","moduleDir","doFind","module","exports","rootDir","join","findIn","libPath","Error","subDir","dir","files","readdirAsync","rex","RegExp","file","test"],"mappings":"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","file":"Library.js","sourcesContent":["'use strict';\nconst _ = require('lodash');\nconst native = require('./native');\nconst assert = require('assert');\nconst Promise = require('bluebird');\nconst async = Promise.coroutine;\nconst fs = Promise.promisifyAll(require('fs'));\nconst path = require('path');\nconst defs = require('./defs');\nconst callMode = defs.callMode;\nconst FastFunction = require('./FastFunction');\nconst FastCallback = require('./FastCallback');\n\nconst defaultOptions = {\n    defaultCallMode: callMode.sync,\n    vmSize: 512\n};\n\nclass Library {\n    constructor(path, options) {\n        assert(_.isString(path) && path.length, 'Argument \"path\" should be a non-empty string.');\n        this.path = path;\n        this.options = Object.freeze(_.defaults(options, defaultOptions));\n        assert(this.options.defaultCallMode === callMode.sync ||\n            this.options.defaultCallMode === callMode.async,\n            '\"options.callMode\" is invalid.');\n        this._pLib = null;\n        this._initialized = false;\n        this._released = false;\n        this._loop = null;\n        this.functions = {};\n        this.callbacks = {};\n        this.interface = {};\n    }\n\n    initialize() {\n        assert(!this._released, `Library \"${ this.path }\" has already been released.`);\n        if (this._initialized) {\n            return;\n        }\n        this._pLib = native.dynload.loadLibrary(this.path);\n        this._loop = native.callback.newLoop();\n        this._initialized = true;\n        return this;\n    }\n\n    release() {\n        if (!this._initialized) {\n            return;\n        }\n        if (this._released) {\n            return;\n        }\n        for (const func of _.values(this.functions)) {\n            func.release();\n        }\n        native.callback.freeLoop(this._loop);\n        native.dynload.freeLibrary(this._pLib);\n        this._released = true;\n        return this;\n    }\n\n    function(def) {\n        return this.options.defaultCallMode === callMode.sync ?\n            this.syncFunction(def) :\n            this.asyncFunction(def);\n    }\n\n    syncFunction(def) {\n        this._addFunction(new FastFunction(this, def, callMode.sync));\n        return this;\n    }\n\n    asyncFunction(def) {\n        this._addFunction(new FastFunction(this, def, callMode.async));\n        return this;\n    }\n\n    callback(def) {\n        this._addCallback(new FastCallback(this, def));\n        return this;\n    }\n\n    _addFunction(func) {\n        assert(!this.functions[func.name], `FastFunction ${ func.name } already declared.`);\n        this.initialize();\n        func.initialize();\n        this.functions[func.name] = func;\n        this.interface[func.name] = func.getFunction();\n    }\n\n    _addCallback(cb) {\n        assert(!this.callbacks[cb.name], `FastCallback ${ cb.name } already declared.`);\n        this.initialize();\n        cb.initialize();\n        this.callbacks[cb.name] = cb;\n        this.interface[cb.name] = cb.getFactory();\n    }\n\n    static get callMode() {\n        return callMode;\n    }\n\n    static find(moduleDir, name) {\n        return doFind(moduleDir, name);\n    }\n}\n\nmodule.exports = Library;\n\nvar doFind = async(function* (moduleDir, name) {\n    assert(_.isString(moduleDir), 'Agument is not a string.');\n\n    const rootDir = path.join(moduleDir, 'build');\n    const libPath =\n        (yield findIn(rootDir, 'Debug', name)) ||\n        (yield findIn(rootDir, 'Release', name));\n    if (!libPath) {\n        throw new Error(`${ name } library not found.`);\n    }\n    return libPath;\n});\n\nvar findIn = async(function* (rootDir, subDir, name) {\n    const dir = path.join(rootDir, subDir);\n    let files;\n    try {\n        files = yield fs.readdirAsync(dir);\n    }\n    catch (err) {\n        return null;\n    }\n    const rex = new RegExp(name);\n    for (const file of files) {\n        if (rex.test(file)) {\n            return path.join(dir, file);\n        }\n    }\n    return null;\n});"]}