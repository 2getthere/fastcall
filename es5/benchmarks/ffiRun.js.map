{"version":3,"sources":["../../benchmarks/ffiRun.js"],"names":["_","require","Promise","async","coroutine","imports","config","assert","common","fastcall","ref","module","exports","importBenchlib","ffiWay","lib","includes","modes","console","log","syncRun","asyncRun","result","addNumbers","addNumbersExp","measure","equal","str1","allocCString","str2","out","Buffer","concatExp","length","readCString","cb","TMakeIntFunc","a","b","makeInt","makeIntExp","addNumbersAsync","promisify","measureAsync","concatAsync","makeIntAsync"],"mappings":"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","file":"ffiRun.js","sourcesContent":["/*\r\nCopyright 2016 Gábor Mező (gabor.mezo@outlook.com)\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\n'use strict';\r\nconst _ = require('lodash');\r\nconst Promise = require('bluebird');\r\nconst async = Promise.coroutine;\r\nconst imports = require('./imports');\r\nconst config = require('./config');\r\nconst assert = require('assert');\r\nconst common = require('./common');\r\nconst fastcall = require('../lib');\r\nconst ref = fastcall.ref;\r\n\r\nmodule.exports = async(function* () {\r\n    const lib = yield imports.importBenchlib.ffiWay();\r\n\r\n    if (_.includes(config.modes, 'sync')) {\r\n        console.log('--- sync ---');\r\n        syncRun(lib);\r\n    }\r\n    if (_.includes(config.modes, 'async')) {\r\n        console.log('--- async ---');\r\n        yield asyncRun(lib);\r\n    }\r\n});\r\n\r\nfunction syncRun(lib) {\r\n    let result;\r\n\r\n    const addNumbers = lib.addNumbersExp;\r\n    common.measure('addNumbers', 3, () => {\r\n        result = addNumbers(addNumbers(5.5, 5), addNumbers(1.1, 1));\r\n    });\r\n    assert.equal(result, 5.5 + 5 + 1 + 1);\r\n\r\n    common.measure('concat', 1, () => {\r\n        const str1 = ref.allocCString(\"Hello,\");\r\n        const str2 = ref.allocCString(\" world!\");\r\n        const out = new Buffer(100);\r\n        lib.concatExp(str1, str2, out, out.length);\r\n        result = ref.readCString(out);\r\n    });\r\n    assert.equal(result, \"Hello, world!\");\r\n\r\n    const cb = lib.TMakeIntFunc((a, b) => a + b);\r\n    const makeInt = lib.makeIntExp;\r\n    common.measure('callback', 3, () => {\r\n        result = makeInt(makeInt(5.5, 5.1, cb, null), makeInt(1.1, 1.8, cb, null), cb, null);\r\n    });\r\n    assert.equal(result, 5 + 5 + 1 + 1);\r\n}\r\n\r\nvar asyncRun = async(function* (lib) {\r\n    let result;\r\n\r\n    const addNumbersAsync =  Promise.promisify(lib.addNumbersExp.async);\r\n    yield common.measureAsync('addNumbers', 3, async(function* () {\r\n        result = yield addNumbersAsync(yield addNumbersAsync(5.5, 5), yield addNumbersAsync(1.1, 1));\r\n    }));\r\n    assert.equal(result, 5.5 + 5 + 1 + 1);\r\n\r\n    const concatAsync =  Promise.promisify(lib.concatExp.async);\r\n    yield common.measureAsync('concat', 1, async(function* () {\r\n        const str1 = ref.allocCString(\"Hello,\");\r\n        const str2 = ref.allocCString(\" world!\");\r\n        const out = new Buffer(100);\r\n        yield concatAsync(str1, str2, out, out.length);\r\n        result = ref.readCString(out);\r\n    }));\r\n    assert.equal(result, \"Hello, world!\");\r\n\r\n    const cb = lib.TMakeIntFunc((a, b) => a + b);\r\n    const makeIntAsync = Promise.promisify(lib.makeIntExp.async);\r\n    yield common.measureAsync('callback', 3, async(function* () {\r\n        result = yield makeIntAsync(yield makeIntAsync(5.5, 5.1, cb, null), yield makeIntAsync(1.1, 1.8, cb, null), cb, null);\r\n    }));\r\n    assert.equal(result, 5 + 5 + 1 + 1);\r\n});"]}